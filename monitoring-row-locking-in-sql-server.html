<!DOCTYPE html>
<html lang="en" class="js flexbox flexboxlegacy canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8" />
    <meta name="keywords" content="">

    <title>Monitoring Row Locking in SQL Server</title>
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />
    <link rel="stylesheet" href="assets/css/toc.css" />
    <link rel="stylesheet" href="assets/css/highlight.css" />
    <link rel="stylesheet" href="assets/css/prism.css" />
    <link rel="stylesheet" href="assets/css/prism-csdiff.css" />


    <link rel="stylesheet" href="assets/css/theme_firefly.css" />
    <link rel="stylesheet" href="assets/css/mermaid.css" />
</head>

<body class="markdown-body" role="document">
    <div class="wrapper" id="root">
        <div class="backdrop"></div>
        <div class="top-bar" role="navigation" aria-label="footer navigation">
            <div style="display:flex;">
                <div>
                    <a id="menu" class="btn btn-neutral">&#9776; </a>
                </div>
                <img src="assets/img/logo-big.png">
            </div>
            <div>
                <a id="previousButton" class="btn btn-neutral" style="visibility:hidden">Previous</a>
                <a id="nextButton" class="btn btn-neutral" style="visibility:hidden">Next</a>
            </div>
        </div>
        <div class="middle">

            <div class="container">

                <div class="content"><h1 id="monitoring-row-locking-in-sql-server">Monitoring Row Locking in SQL Server</h1>
<p>Many times we want to add to our application the method the information of who is locking, and what is being locked.</p>
<p>In this article we'll describe several ways to do that.</p>
<h2 id="seeing-which-tables-are-locked-and-who-is-locking-them">Seeing which tables are locked and who is locking them</h2>
<p>You can use the following query, to see the current tables that are locked and who is locking them:</p>
<pre><code class="language-sql">SELECT 
	OBJECT_NAME(rsc_objid,rsc_dbid) 'TableName', 
	b.login_name 'Locking User Sql Login Name',
    b.nt_user_name 'Locking User Windows Login Name',
	b.session_id 'Sql Session Id',
	b.program_name,
	b.host_name 'Locking Computer Name',
	b.host_process_id 'Locking Process Id'
FROM master.dbo.syslockinfo a left outer join sys.dm_exec_sessions b on a.req_spid=b.session_id 
WHERE  req_spid&gt;=0 AND rsc_objid&gt;0 AND rsc_type=5
</code></pre>
<blockquote>
<p>See the end of this article for other, (and even more useful) queries that were found after this article was originally written
Here's a sample result:</p>
</blockquote>
<p><img src="2019-09-26_10h38_58.png" alt="" /></p>
<blockquote>
<p>For customers that have migrated from btrieve to Sql up to 2018, see the following article for a query that will display locking:
<a href="http://doc.fireflymigration.com/locking-after-btrieve-to-sql-migration.html">http://doc.fireflymigration.com/locking-after-btrieve-to-sql-migration.html</a></p>
</blockquote>
<p>Here's an example of a <code>UIController</code> that runs this sql:</p>
<pre data-line="" class="language-csdiff line-numbers"><code>class ShowLocks : UIControllerBase
{
    public readonly TextColumn TableName = new TextColumn("Locked Table");
    public readonly TextColumn LockingSqlUser = new TextColumn("Locking User Sql Login Name");
    public readonly TextColumn LockingWindwsUser = new TextColumn("Locking User Windows Login Name");
    public readonly NumberColumn Session = new NumberColumn("Sql Session Id","5");
    public readonly TextColumn ProgramName = new TextColumn("Program Name");
    public readonly TextColumn ComputerName = new TextColumn("Locking Computer Name");
    public readonly NumberColumn ProcessId = new NumberColumn("Locking Computer Process Id", "6");
    public ShowLocks()
    {
        
    }
    protected override void OnLoad()
    {
        Activity = Activities.Browse;
        View = () =&gt; new ENV.UI.GridView(this.Columns.ToArray());
    }
    
    public void Run()
    {
        var sql = @"SELECT 
OBJECT_NAME(rsc_objid,rsc_dbid) 'TableName', 
b.login_name 'Locking User Sql Login Name',
b.nt_user_name 'Locking User Windows Login Name',
b.session_id 'Sql Session Id',
b.program_name,
b.host_name 'Locking Computer Name',
b.host_process_id 'Locking Process Id'
FROM master.dbo.syslockinfo a left outer join sys.dm_exec_sessions b on a.req_spid=b.session_id 
WHERE  req_spid&gt;=0 AND rsc_objid&gt;0 AND rsc_type=5";

        var sqlEntity = new DynamicSQLEntity(Shared.DataSources.Northwind,sql);

        sqlEntity.Columns.Add(TableName, LockingSqlUser, LockingWindwsUser, Session, ProgramName, ComputerName, ProcessId);
        From = sqlEntity;
        
        Execute();
    }
} </code></pre>
<h2 id="showing-to-the-locked-user-who-is-locking-the-table-they-are-trying-to-use">Showing to the locked user, who is locking the table they are trying to use</h2>
<p>If you want to display to the user what other users are locking the table they are trying to access - let's modify the <code>ShowLocks</code> controller to filter on a table:</p>
<pre data-line="20,33,34,35,36,37" class="language-csdiff line-numbers"><code>class ShowLocks : UIControllerBase
{
    public readonly TextColumn TableName = new TextColumn("Locked Table");
    public readonly TextColumn LockingSqlUser = new TextColumn("Locking User Sql Login Name");
    public readonly TextColumn LockingWindwsUser = new TextColumn("Locking User Windows Login Name");
    public readonly NumberColumn Session = new NumberColumn("Sql Session Id","5");
    public readonly TextColumn ProgramName = new TextColumn("Program Name");
    public readonly TextColumn ComputerName = new TextColumn("Locking Computer Name");
    public readonly NumberColumn ProcessId = new NumberColumn("Locking Computer Process Id", "6");
    public ShowLocks()
    {
        
    }
    protected override void OnLoad()
    {
        Activity = Activities.Browse;
        View = () =&gt; new ENV.UI.GridView(this.Columns.ToArray());
    }
-   public void Run()   
    public void Run(Text lockedTable=null)
    {
        var sql = @"SELECT 
OBJECT_NAME(rsc_objid,rsc_dbid) 'TableName', 
b.login_name 'Locking User Sql Login Name',
b.nt_user_name 'Locking User Windows Login Name',
b.session_id 'Sql Session Id',
b.program_name,
b.host_name 'Locking Computer Name',
b.host_process_id 'Locking Process Id'
FROM master.dbo.syslockinfo a left outer join sys.dm_exec_sessions b on a.req_spid=b.session_id 
WHERE  req_spid&gt;=0 AND rsc_objid&gt;0 AND rsc_type=5";

        if (!Text.IsNullOrEmpty(lockedTable))
        {
            sql += " and rsc_objid=object_id('" + lockedTable.Trim().Replace("'", "''") + "')";
            sql += " and b.session_id!=@@spid"; //exclude my locks
        }

        var sqlEntity = new DynamicSQLEntity(Shared.DataSources.Northwind,sql);

        sqlEntity.Columns.Add(TableName, LockingSqlUser, LockingWindwsUser, Session, ProgramName, ComputerName, ProcessId);
        From = sqlEntity;
        
        Execute();
    }
} </code></pre>
<p>And add an handler in the  <code>AppliationCore</code> class.</p>
<pre data-line="" class="language-csdiff line-numbers"><code>Handlers.AddDatabaseErrorHandler(DatabaseErrorType.LockedRow).Invokes += e =&gt;
{
    new ShowLocks().Run(e.Entity.EntityName);
}; </code></pre>
<p>You can also change the default behavior when locking from retry to abort by changing the <code>HandlingStrategy</code></p>
<pre data-line="4" class="language-csdiff line-numbers"><code>Handlers.AddDatabaseErrorHandler(DatabaseErrorType.LockedRow).Invokes += e =&gt;
{
    new ShowLocks().Run(e.Entity.EntityName);
    e.HandlingStrategy = DatabaseErrorHandlingStrategy.RollbackAndRecover;
}; </code></pre>
<h2 id="kill-the-locking-session">Kill the locking session</h2>
<p>If you want to kill the locking session, you can use the  <a href="https://docs.microsoft.com/en-us/sql/t-sql/language-elements/kill-transact-sql">KILL (Transact-SQL)</a>.</p>
<p>Here's how we add that to our controller:</p>
<pre data-line="5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22" class="language-csdiff line-numbers"><code>protected override void OnLoad()
{
    Activity = Activities.Browse;
-   View = () =&gt; new ENV.UI.GridView(this.Columns.ToArray());
    View = () =&gt;
    {
        var v = new ENV.UI.GridView(this.Columns.ToArray());
        v.AddAction("Kill Session", () =&gt;
        {
            try
            {
                Shared.DataSources.Northwind.Execute("kill " + Session.ToString().Trim() + "");
                Common.ShowMessageBox("Kill session " + Session.ToString().Trim(), MessageBoxIcon.Information, "Session Killed");
            }

            catch (Exception ex)
            {
                Common.ShowMessageBox("Kill session " + Session.ToString().Trim(), MessageBoxIcon.Error, "Failed to kill session: "+ex.Message);
            }
        });
        return v;
    };
} </code></pre>
<p>Now the user can kill the session by right clicking on it and choosing kill session:</p>
<p><img src="2019-09-26_10h40_29.png" alt="" /></p>
<h2 id="we-are-using-the-same-sql-account-for-all-our-users-how-can-we-know-who-is-the-locking-user">&quot;We are using the same Sql account for all our users, how can we know who is the locking user?&quot;</h2>
<p>Often a single sql server user account is used, but we still want to know what is the user that logged in to the application.
In .NET we have control of the sql <code>Program_name</code>:</p>
<p><img src="2019-09-26_10h40_59.png" alt="" /></p>
<p>We can change it to include the user that was used to login to the application.
On the <code>ConnectionManager</code> class in ENV, you'll find, search for the word <code>applicationName</code> and make the following change:</p>
<pre data-line="12" class="language-csdiff line-numbers"><code>if (n != null)
{
    var
        applicationName
            =
            n.Name +
            "_" +
            n.Version
                .
                ToString
                ();
    applicationName += "|" + Security.UserManager.CurrentUser.Name;
    connect.Append(
        "Application Name=" +
        applicationName +
        ";");
} </code></pre>
<p>And you'll see it in the <code>program_name</code> column:</p>
<p><img src="2019-09-26_10h46_41.png" alt="" /></p>
<h2 id="how-can-we-know-on-which-screen-the-user-is-now">&quot;How can we know on which screen the user is now?&quot;</h2>
<p>The way to do that is to create a table that will know where the user is, and update it every x Seconds.</p>
<p>The following code sample records every 5 seconds the:</p>
<ol>
<li>Screen - the Form that the user is on</li>
<li>Contorller - the Controller the user was on.</li>
<li>ControllerThatOpenedTheTransaction - the controller where the transaction was opened.</li>
<li>LastUpdate - the last time the values has changed (if the user is on the screen for an hour, there is no point in updating the db again and again, youll see it using ths value.)</li>
</ol>
<p>Add the following entity to the application.</p>
<pre data-line="" class="language-csdiff line-numbers"><code>public class SqlSessionAdditionalInfo : Entity
{
    [PrimaryKey]
    public readonly NumberColumn Session = new NumberColumn("SqlSessionId", "5");
    public readonly Firefly.Box.Data.DateTimeColumn LastUpdate = new Firefly.Box.Data.DateTimeColumn("LastUpdate");
    public readonly TextColumn Screen = new TextColumn("Screen", "2000");
    public readonly TextColumn Controller = new TextColumn("Controller", "2000");
    public readonly TextColumn ControllerThatOpenedTheTransaction = new TextColumn("ControllerThatOpenedTheTransaction", "2000");
    public SqlSessionAdditionalInfo() : base("SqlSessionAdditionalInfo", Shared.DataSources.Northwind)
    {

    }
} </code></pre>
<p>In the <code>ApplicationCore</code> class add the following handler</p>
<pre data-line="" class="language-csdiff line-numbers"><code>var lastKkey = "";
var tableExists = false;
Number currentSsessionId = null;
Handlers.Add(Command.CreateTimer(5)).Invokes += e =&gt;
{

    var screenName = "Application";
    ITask controller = null;
    ITask controllerThatOpenedTheTransaction = null;

    foreach (var c in Context.Current.ActiveTasks)
    {
        if (c.View != null &amp;&amp; !c.View.ChildWindow)
            screenName = c.View.Text;
        controller = c;
        if (controllerThatOpenedTheTransaction == null &amp;&amp; c.InTransaction)
            controllerThatOpenedTheTransaction = c;
    }
    var controllerName = "";
    var transactionControllerName = "";
    if (controller!=null)
        //note that you'll need to change the SendInstanceBasedOnTaskAndCallStack method to public :)
        ControllerBase.SendInstanceBasedOnTaskAndCallStack(controller, c =&gt; controllerName = c.GetType().FullName);
    if (controllerThatOpenedTheTransaction!=null)
        ControllerBase.SendInstanceBasedOnTaskAndCallStack(controllerThatOpenedTheTransaction, c =&gt; transactionControllerName = c.GetType().FullName);

    var key = controllerName + screenName + controllerThatOpenedTheTransaction;
    if (key == lastKkey)
        return; //we only want to update the session info if it has changed. If the user is on the screen for a while, there is no point in sending an update every 5 seconds.
    lastKkey = key;
    var sInfo = new SqlSessionAdditionalInfo();
    if (!tableExists)
    {
        tableExists = sInfo.Exists();
        if (!tableExists)
            Shared.DataSources.Northwind.CreateTable(sInfo);
        tableExists = true;
    }
    if (currentSsessionId == null)
    {
        // get the spid if we don't already know it
        using (var c = Shared.DataSources.Northwind.CreateCommand())
        {
            c.CommandText = "select @@spid";
            currentSsessionId = Number.Cast(c.ExecuteScalar());
        }
    }

    sInfo.InsertIfNotFound(sInfo.Session.BindEqualTo(currentSsessionId), () =&gt;
    {
        sInfo.LastUpdate.Value = System.DateTime.Now;
        sInfo.Screen.Value = screenName;
        sInfo.Controller.Value = controllerName;
        sInfo.ControllerThatOpenedTheTransaction.Value = transactionControllerName;
    });
}; </code></pre>
<p>You can query this from the database using the following sql:</p>
<pre><code class="language-sql">select * from SqlSessionAdditionalInfo with(nolock)
</code></pre>
<p>Or you can add this info to the <code>ShowLocks</code></p>
<pre data-line="8,9,10,11,12,13,14,15,16,17,18,19" class="language-csdiff line-numbers"><code>...
protected override void OnLoad()
{
    Activity = Activities.Browse;
    View = () =&gt;
    {
        var v = new ENV.UI.GridView(this.Columns.ToArray());
        v.AddAction("Additional Info", () =&gt;
        {
            var sInfo = new SqlSessionAdditionalInfo();
            sInfo.ForEachRow(sInfo.Session.IsEqualTo(Session), () =&gt;
            {
                Common.ShowMessageBox("Session Info " + Session.ToString().Trim(), MessageBoxIcon.Information,
                    "Screen: " + sInfo.Screen.Value.Trim() +
                    "\r\nController: " + sInfo.Controller.Value.Trim() +
                    "\r\nTransaction Opened On: " + sInfo.ControllerThatOpenedTheTransaction.Trim() +
                    "\r\nEstimated duration on Screen: " + (DateTime.Now - sInfo.LastUpdate).Minutes.ToString() + " minutes");
            });
        });
        v.AddAction("Kill Session", () =&gt;
        {
            try
            {
                Shared.DataSources.Northwind.Execute("kill " + Session.ToString().Trim() + "");
                Common.ShowMessageBox("Kill session " + Session.ToString().Trim(), MessageBoxIcon.Information, "Session Killed");
            }

            catch (Exception ex)
            {
                Common.ShowMessageBox("Kill session " + Session.ToString().Trim(), MessageBoxIcon.Error, "Failed to kill session: " + ex.Message);
            }
        });
        return v;
    };
}

... </code></pre>
<p>And it'll look like this:</p>
<p><img src="2019-09-26_15h55_25.png" alt="" /></p>
<p><img src="2019-09-26_15h55_51.png" alt="" /></p>
<h3 id="update-another-sql-monitoring-query">UPDATE: Another SQL Monitoring Query</h3>
<p>Recently I've ran into another great query to show the lock info, including the last sql for that connection:</p>
<pre><code class="language-sql">
SELECT  L.request_session_id AS SPID,
        DB_NAME(L.resource_database_id) AS DatabaseName,
        O.Name AS LockedObjectName,
		l.resource_associated_entity_id,
		l.resource_description,
        P.object_id AS LockedObjectId,
        L.resource_type AS LockedResource,
        L.request_mode AS LockType,
        ST.text AS SqlStatementText,    
		ES.login_name 'Locking User Sql Login Name',
		ES.nt_user_name 'Locking User Windows Login Name',
		ES.session_id 'Sql Session Id',
		ES.program_name,
		ES.host_name 'Locking Computer Name',   
        TST.is_user_transaction as IsUserTransaction,
        CN.auth_scheme as AuthenticationMethod
		
FROM    sys.dm_tran_locks L
        JOIN sys.partitions P ON P.hobt_id = L.resource_associated_entity_id
        left outer JOIN sys.objects O ON O.object_id = P.object_id
        JOIN sys.dm_exec_sessions ES ON ES.session_id = L.request_session_id
         JOIN sys.dm_tran_session_transactions TST ON ES.session_id = TST.session_id
        JOIN sys.dm_tran_active_transactions AT ON TST.transaction_id = AT.transaction_id
        JOIN sys.dm_exec_connections CN ON CN.session_id = ES.session_id
        CROSS APPLY sys.dm_exec_sql_text(CN.most_recent_sql_handle) AS ST
WHERE   resource_database_id = db_id()
ORDER BY L.request_session_id
</code></pre>
<h3 id="update-2-finding-the-locked-row">UPDATE 2: Finding the locked row</h3>
<p>When you run the previous select, the column <code>resource_description</code> holds the key to find the actual locked row.
Any table has a &quot;virtual&quot; column that represents that value called <code>%%lockres%%</code> which can be used to find the specific row</p>
<p>For example - if the <code>LockedObjectName</code> is <code>Customers</code> and the <code>resource_description</code> is &quot;(46003d087fa5)&quot;</p>
<p>The following query will reutrn the locked customer row:</p>
<pre><code class="language-SQL">select *,%%lockres%% from customers with (nolock) WHERE %%lockres%% = '(46003d087fa5)'
</code></pre>



                    <hr />Help us improve,
                    <a href="https://github.com/FireflyMigration/firefly-doc/blob/master//20-Getting-Familiar-with-Migrated-Code/50-DataAccess/50-Transactions-and-locking/25-Monitoring Row Locking in SQL Server/index.md" target="_blank">Edit this page on GitHub</a>
                    <br /> or email us at
                    <a href="mailto:info@fireflymigration.com?Subject=Firefly%20Documentation%20Website" target="_top">info@fireflymigration.com</a>
                </div>

                <!-- .content -->




            </div>
            <!-- .container-->

            <aside class="left-sidebar">
                <div class="wy-side-nav-search-ff">
                    <a href="" class="test">
                        
                    </a>
                </div>
                <div id="menuTree" </div>
            </aside>
            <!-- .left-sidebar -->

            <aside class="right-sidebar"></aside>
            <!-- .right-sidebar -->

            </div>
            <!-- .middle-->



        </div>


        <script src="assets/js/mermaid.js"></script>
        <script src="assets/js/prism-start.js"></script>
        <script src="assets/js/prism-clike.js"></script>
        <script src="assets/js/prism-markup.js"></script>
        <script src="assets/js/prism-css.js"></script>
        <script src="assets/js/prism-javascript.js"></script>

        <script src="assets/js/prism-diff.js"></script>
        <script src="assets/js/prism-csdiff.js"></script>
        <script src="assets/js/prism-function.js"></script>

        <script src="assets/js/jquery-3.1.1.js"></script>


        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-4806432-3', 'auto');
            ga('send', 'pageview');

        </script>
        <script src="assets/js/tree.js"></script>
        <script language="javascript">
            buildTree('menuTree', 'monitoring-row-locking-in-sql-server.html', 'previousButton', 'nextButton');
        </script>
</body>

</html>