<!DOCTYPE html>
<html lang="en" class="js flexbox flexboxlegacy canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8" />
    <meta name="keywords" content="RunOnUIThread,RunOnLogicThread,RunInUIThread,RunInLogicThread">

    <title>Understanding UI and Treads Pitfalls</title>
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />
    <link rel="stylesheet" href="assets/css/toc.css" />
    <link rel="stylesheet" href="assets/css/highlight.css" />
    <link rel="stylesheet" href="assets/css/prism.css" />
    <link rel="stylesheet" href="assets/css/prism-csdiff.css" />


    <link rel="stylesheet" href="assets/css/theme_firefly.css" />
    <link rel="stylesheet" href="assets/css/mermaid.css" />
</head>

<body class="markdown-body" role="document">
    <div class="wrapper" id="root">
        <div class="backdrop"></div>
        <div class="top-bar" role="navigation" aria-label="footer navigation">
            <div style="display:flex;">
                <div>
                    <a id="menu" class="btn btn-neutral">&#9776; </a>
                </div>
                <img src="assets/img/logo-big.png">
            </div>
            <div>
                <a id="previousButton" class="btn btn-neutral" style="visibility:hidden">Previous</a>
                <a id="nextButton" class="btn btn-neutral" style="visibility:hidden">Next</a>
            </div>
        </div>
        <div class="middle">

            <div class="container">

                <div class="content"><h1 id="understanding-ui-and-treads-pitfalls">Understanding UI and Treads Pitfalls</h1>
<p>When working with multiple threads that present forms, one must be aware of the threads in which one is running, and what exactly they are trying to do.</p>
<h2 id="background">Background</h2>
<p>When running an application with one thread, everything is simple, both the logic and the UI run on the same thread and it all works great.</p>
<p>When you run things in parallel, it gets a bit more complicated than that.</p>
<p>For each call to &quot;RunAsync&quot; a new thread opens, and runs that code. In that thread you can find the call stack of all running tasks, the thread will use a different connection from the previous thread and will manage all of it's transaction etc.....</p>
<p>UNfortunately windows have a limitation that all call to code that concerns the UI, must be made in the thread where the form was originally created.</p>
<p>Let's look at a scenario:</p>
<ol>
<li>we ran the application and have Thread 1 that serves both as UI thread and logic thread.</li>
<li>On thread one, we open the MDI form and a few other forms.</li>
<li>We call <code>RunAsync</code> to run a program in a new thread - Thread 2.</li>
<li>We want that program on Thread 2, to open a form, that will still be in the MDI that was created in Thread 1.</li>
<li>When we do that in windows forms, we'll get a <code>Cross-thread operation not valid</code> exception.
Windows expects that when you want to run a command on the UI from Thread 2, you'll take care to switch back to the UI thread and run the command there.</li>
</ol>
<p>The migrated code takes care of that for you, and makes sure that any UI command will be run on the UI thread - and any logic command will be run on the Logic Thread (Thread 2 in our case)</p>
<p>Let's consider the following:</p>
<ol>
<li>On Thread 2, we have a controller with a button that when it's clicked, we want  it to run a child controller on Thread 2.</li>
<li>The Original button Click Command, happens in the UI Thread - but the migrated code, makes sure to switch it to execute in the Logic Thread (Thread 2) to get a coherent behavior.</li>
</ol>
<h2 id="helper-methods">Helper methods</h2>
<p>To provide you with the same control we use, there are two important methods that you can use:</p>
<ol>
<li><code>Context.Current.InvokeUICommand</code> - To be used while you're in the logic thread, and you want to run something on the UI thread, like setting a control's text etc....</li>
<li><code>RunInLogicContext</code>, exists in the form be used to make sure that the code that is about to run will be executed in the relevant logic thread.</li>
</ol>
<p>When you are using a non migrated control, that fire events, and in these events you want to call code that will run in the logic thread, you must use the <code>RunInLogicContext</code> method for that.
For example:</p>
<pre data-line="3,4,6" class="language-csdiff line-numbers"><code>private void button2_Click(object sender, System.EventArgs e)
{
    RunInLogicContext(() =&gt;
    {
        new SomeProgram().Run();
    });
} </code></pre>
<h2 id="what-will-happen-if-i-dont-do-that">What will happen if I don't do that</h2>
<p>Well, you might run into trouble :)</p>
<p>In some cases you would get an exception of type <code>Thread blocked by UI code</code> (in previous version you might get a <code>NotImplementedException</code>)</p>



                    <hr />Help us improve,
                    <a href="https://github.com/FireflyMigration/firefly-doc/blob/master//30-Maintaining-the-Migrated-Application/Multi-Threading-and-Contexts/Understanding UI and Treads Pitfalls.md" target="_blank">Edit this page on GitHub</a>
                    <br /> or email us at
                    <a href="mailto:info@fireflymigration.com?Subject=Firefly%20Documentation%20Website" target="_top">info@fireflymigration.com</a>
                </div>

                <!-- .content -->




            </div>
            <!-- .container-->

            <aside class="left-sidebar">
                <div class="wy-side-nav-search-ff">
                    <a href="" class="test">
                        
                    </a>
                </div>
                <div id="menuTree" </div>
            </aside>
            <!-- .left-sidebar -->

            <aside class="right-sidebar"></aside>
            <!-- .right-sidebar -->

            </div>
            <!-- .middle-->



        </div>


        <script src="assets/js/mermaid.js"></script>
        <script src="assets/js/prism-start.js"></script>
        <script src="assets/js/prism-clike.js"></script>
        <script src="assets/js/prism-markup.js"></script>
        <script src="assets/js/prism-css.js"></script>
        <script src="assets/js/prism-javascript.js"></script>

        <script src="assets/js/prism-diff.js"></script>
        <script src="assets/js/prism-csdiff.js"></script>
        <script src="assets/js/prism-function.js"></script>

        <script src="assets/js/jquery-3.1.1.js"></script>


        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-4806432-3', 'auto');
            ga('send', 'pageview');

        </script>
        <script src="assets/js/tree.js"></script>
        <script language="javascript">
            buildTree('menuTree', 'understanding-ui-and-treads-pitfalls.html', 'previousButton', 'nextButton');
        </script>
</body>

</html>