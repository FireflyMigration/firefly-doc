<!DOCTYPE html>
<html lang="en" class="js flexbox flexboxlegacy canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8" />
    <meta name="keywords" content="">

    <title>Import file helper</title>
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />
    <link rel="stylesheet" href="assets/css/toc.css" />
    <link rel="stylesheet" href="assets/css/highlight.css" />
    <link rel="stylesheet" href="assets/css/prism.css" />
    <link rel="stylesheet" href="assets/css/prism-csdiff.css" />


    <link rel="stylesheet" href="assets/css/theme_firefly.css" />
    <link rel="stylesheet" href="assets/css/mermaid.css" />
</head>

<body class="markdown-body" role="document">
    <div class="wrapper" id="root">
        <div class="backdrop"></div>
        <div class="top-bar" role="navigation" aria-label="footer navigation">
            <div style="display:flex;">
                <div>
                    <a id="menu" class="btn btn-neutral">&#9776; </a>
                </div>
                <img src="assets/img/logo-big.png">
            </div>
            <div>
                <a id="previousButton" class="btn btn-neutral" style="visibility:hidden">Previous</a>
                <a id="nextButton" class="btn btn-neutral" style="visibility:hidden">Next</a>
            </div>
        </div>
        <div class="middle">

            <div class="container">

                <div class="content"><h1 id="import-file-helper">Import file helper</h1>
<p>I needed to import a file with 300 different fields, but no clear view of it's structure.</p>
<p>I needed a screen where I can set the position and width of the columns, and then import based on it, so I've created the Import Helper.</p>
<p>It's not polished, but if you want you can use it.</p>
<h2 id="usage">usage</h2>
<pre data-line="9,11,14,15,16,17" class="language-csdiff line-numbers"><code>protected override void OnLoad()
{
    Exit(ExitTiming.BeforeRow, () =&gt; _io.EndOfFile);
    Activity = Activities.Insert;

    _io = new ENV.IO.FileReader("file.TXT") ;
    Streams.Add(_io);

    _importHelper = new ImportHelper("ImportSettings.xml", Columns.ToArray());
}
ImportHelper _importHelper;
protected override void OnLeaveRow()
{
    var x = _io.ReadLine();
    if (false)
        _importHelper.ShowSettingsScreen(x);
    _importHelper.ReadLine(x);
} </code></pre>
<h2 id="source-code">source code</h2>
<pre data-line="" class="language-csdiff line-numbers"><code>class ImportHelper
{
    ENV.Data.DataProvider.MemoryDatabase mdb = new ENV.Data.DataProvider.MemoryDatabase();
    Dictionary&lt;int, ColumnBase&gt; _columnsMap = new Dictionary&lt;int, ColumnBase&gt;();
    string _settingsFileName;
    public ImportHelper(string settingsFileName,ColumnBase[] columns)
    {
        _settingsFileName = settingsFileName;
        _columnsMap.Clear();
        var ih = new ImportHelperEntity(mdb);
        if (System.IO.File.Exists(settingsFileName))
        {
            mdb.DataSet.Clear();
            ih.Insert(() =&gt; ih.ID.Value = 1);
            ih.Truncate();
            mdb.DataSet.ReadXml(settingsFileName);
        }


        int left = 1;
        foreach (var item in columns)
        {

            ih.Left.BindValue(() =&gt; left);
            ih.Width.BindValue(() =&gt; item.FormatInfo.MaxLength);
            ih.Order.BindValue(ih.ID);
            ih.InsertIfNotFound(ih.ID.BindEqualTo(() =&gt; _columnsMap.Count + 1), () =&gt;
            {
                ih.ColumnName.Value = item.Caption;
                ih.Info.Value = UserMethods.GetAttribute(item) + ":" + item.Format;
                _columnsMap.Add(ih.ID, item);

                left += 1 + ih.Width;
            });


        }
    }
    class ImportHelperEntity : ENV.Data.Entity
    {

        [PrimaryKey]
        public readonly NumberColumn ID = new NumberColumn("ID", "3");
        public readonly NumberColumn Order = new NumberColumn("Order", "3");
        public readonly TextColumn ColumnName = new TextColumn("ColName", "30");
        public readonly TextColumn Info = new TextColumn("Info", "15");
        public readonly NumberColumn Left = new NumberColumn("Lef", "5", "Left");
        public readonly NumberColumn Width = new NumberColumn("Width", "5");
        public Text GetTextFromRow(string s)
        {
            return ENV.UserMethods.Instance.Mid(s, Left, Width);
        }
        public void SetColumnBasedOn(string stringFromFile,Dictionary&lt;int,ColumnBase&gt; columnsMap)
        {
            var col = columnsMap[ID];
            col.Value = col.Parse(GetTextFromRow(stringFromFile), col.Format);

        }

        public ImportHelperEntity(IEntityDataProvider mdb) : base("helper", mdb)
        { }
    }

    public void ReadLine(string stringFromLine)
    {
        var ih = new ImportHelperEntity(mdb);
        ih.ForEachRow(() =&gt; ih.SetColumnBasedOn(stringFromLine,_columnsMap));
    }

    public  void ShowSettingsScreen(string stringFromFile)
    {
        var ih = new ImportHelperEntity(mdb); 
        var eb = new ENV.Utilities.EntityBrowser(ih, true);

        var right = new NumberColumn("Right", "5");
        right.BindValue(() =&gt; ih.Left + ih.Width);
        right.ValueChanged += e =&gt;
        {
            if (e.ChangedByUser)
                ih.Left.Value = right - ih.Width;
        };

        var parsedData = new TextColumn("Data", "32000");
        parsedData.BindValue(() =&gt; ih.GetTextFromRow(stringFromFile));


        var value = new TextColumn("Value", "32000");
        value.BindValue(() =&gt;
        {
            try
            {

                var col = _columnsMap[ih.ID];
                ih.SetColumnBasedOn(stringFromFile,_columnsMap);
                return col.ToString();

            }
            catch (Exception exx)
            {
                return exx.Message;
            }
        });
        eb.AddColumns(ih.Order, ih.ColumnName, ih.Info, ih.Left, ih.Width, right, parsedData, value);
        eb.AddAction("Save", () =&gt; mdb.DataSet.WriteXml(_settingsFileName, System.Data.XmlWriteMode.WriteSchema), true);

        Action moveforward = () =&gt;
        {
            var ih2 = new ImportHelperEntity(mdb);
            var left = right + 1;
            ih2.ForEachRow(ih2.Order.IsGreaterThan(ih.Order), new Sort(ih2.Order), () =&gt;
            {
                ih2.Left.Value = left;
                left += ih2.Width + 1;
            });
        };

        eb.AddAction("Reposition Following Columns", o =&gt;
        {
            o.SaveRowAndDo(xx =&gt;
            {
                moveforward();
                xx.ReloadData(true);
            });
        });

        eb.Handlers.Add(new CustomCommand()
        {
            Shortcut = System.Windows.Forms.Keys.Control | System.Windows.Forms.Keys.Left,
            Precondition = CustomCommandPrecondition.LeaveControl
        }).Invokes += e =&gt; ih.Left.Value--;
        eb.Handlers.Add(new CustomCommand()
        {
            Shortcut = System.Windows.Forms.Keys.Control | System.Windows.Forms.Keys.Right,
            Precondition = CustomCommandPrecondition.LeaveControl
        }).Invokes += e =&gt; ih.Left.Value++;
        eb.Handlers.Add(new CustomCommand()
        {
            Shortcut = System.Windows.Forms.Keys.Control | System.Windows.Forms.Keys.P,
            Precondition = CustomCommandPrecondition.LeaveRow
        }).Invokes += e =&gt;
        {
            moveforward();
            ENV.Common.Raise(Command.ReloadData);
        };
        eb.Run();
            
    }
} </code></pre>



                    <hr />Help us improve,
                    <a href="https://github.com/FireflyMigration/firefly-doc/blob/master//30-Maintaining-the-Migrated-Application/60-Further-Learning/Import-file-helper.md" target="_blank">Edit this page on GitHub</a>
                    <br /> or email us at
                    <a href="mailto:info@fireflymigration.com?Subject=Firefly%20Documentation%20Website" target="_top">info@fireflymigration.com</a>
                </div>

                <!-- .content -->




            </div>
            <!-- .container-->

            <aside class="left-sidebar">
                <div class="wy-side-nav-search-ff">
                    <a href="" class="test">
                        
                    </a>
                </div>
                <div id="menuTree" </div>
            </aside>
            <!-- .left-sidebar -->

            <aside class="right-sidebar"></aside>
            <!-- .right-sidebar -->

            </div>
            <!-- .middle-->



        </div>


        <script src="assets/js/mermaid.js"></script>
        <script src="assets/js/prism-start.js"></script>
        <script src="assets/js/prism-clike.js"></script>
        <script src="assets/js/prism-markup.js"></script>
        <script src="assets/js/prism-css.js"></script>
        <script src="assets/js/prism-javascript.js"></script>

        <script src="assets/js/prism-diff.js"></script>
        <script src="assets/js/prism-csdiff.js"></script>
        <script src="assets/js/prism-function.js"></script>

        <script src="assets/js/jquery-3.1.1.js"></script>


        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-4806432-3', 'auto');
            ga('send', 'pageview');

        </script>
        <script src="assets/js/tree.js"></script>
        <script language="javascript">
            buildTree('menuTree', 'import-file-helper.html', 'previousButton', 'nextButton');
        </script>
</body>

</html>