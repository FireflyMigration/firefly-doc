<!DOCTYPE html>
<html lang="en" class="js flexbox flexboxlegacy canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8" />
    <meta name="keywords" content="">

    <title>Creating our own Encrypted Storage</title>
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />
    <link rel="stylesheet" href="assets/css/toc.css" />
    <link rel="stylesheet" href="assets/css/highlight.css" />
    <link rel="stylesheet" href="assets/css/prism.css" />
    <link rel="stylesheet" href="assets/css/prism-csdiff.css" />


    <link rel="stylesheet" href="assets/css/theme_firefly.css" />
    <link rel="stylesheet" href="assets/css/mermaid.css" />
</head>

<body class="markdown-body" role="document">
    <div class="wrapper" id="root">
        <div class="backdrop"></div>
        <div class="top-bar" role="navigation" aria-label="footer navigation">
            <div style="display:flex;">
                <div>
                    <a id="menu" class="btn btn-neutral">&#9776; </a>
                </div>
                <img src="assets/img/logo-big.png">
            </div>
            <div>
                <a id="previousButton" class="btn btn-neutral" style="visibility:hidden">Previous</a>
                <a id="nextButton" class="btn btn-neutral" style="visibility:hidden">Next</a>
            </div>
        </div>
        <div class="middle">

            <div class="container">

                <div class="content"><h1 id="creating-our-own-encrypted-storage">Creating our own Encrypted Storage</h1>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Z1uljBHEXs8?list=PL1DEQjXG2xnJF4Jon_mjd-QnmsQ3KBWLr" frameborder="0" allowfullscreen></iframe>
<p>Storage is a column attribute, which defines the way the value of the columns is saved to the database and loaded from it.
Storage is used to separate the way a value is stored in persistant storage from the way it is used by the application.
There are many built in storages that we can use. For example,the DateTimeDateStorage is used to store dates as DateTime in the Database, while the StringDateStorage allows us to keep dates as strings.
The migrated application comes with a plethora of storages for numbers, texts, dates, times and bool.</p>
<p>With the rise of internet services and mobile apps, many regulations have been made to keep our personal data protected.
For example, to comply with GPDR, companies are required to encrypt any personal identifiable information (PII), such as id numbers, emails, credit card numbers etc.
We are often asked how to implement this in migrated applicaitons. Storage is a great way to do it.</p>
<h3 id="we-need-an-encryptor">We need an Encryptor</h3>
<p>Assuming that we have some kind of encryption mecahnism, here is a simple examle of an encryptor class:</p>
<pre data-line="" class="language-csdiff line-numbers"><code>using System;
using System.Text;

namespace Northwind.Demo
{
    public static class Encryptor
    {
        static ENV.UserMethods u = new ENV.UserMethods();
        static byte[] key = Encoding.Unicode.GetBytes("MyKey");

        public static string EncryptToBase64(string value)
        {
            return Convert.ToBase64String(u.Cipher(1, Encoding.Unicode.GetBytes(value.TrimEnd()), key));
        }

        public static string DecryptFromBase64(string value)
        {
            return Encoding.Unicode.GetString(u.DeCipher(1, Convert.FromBase64String(value), key));
        }
    }
} </code></pre>
<h3 id="creating-our-storage">Creating our Storage</h3>
<p>All storages implement a simple interface named IColumnStorageStrategy<T> with two methods, LoadFrom and SaveTo.
Let's create our own storage class and implement this interface using our Encryptor:</p>
<pre data-line="" class="language-csdiff line-numbers"><code>using Firefly.Box;
using Firefly.Box.Data.DataProvider;

namespace Northwind.Demo
{
    class EncryptedTextStorage : IColumnStorageSrategy&lt;Text&gt;
    {
        public Text LoadFrom(IValueLoader loader)
        {
            var dbVal = loader.GetString();
            return Encryptor.DecryptFromBase64(dbVal);
        }

        public void SaveTo(Text value, IValueSaver saver)
        {
            if (value == null)
                saver.SaveNull();
            else
                saver.SaveString(Encryptor.EncryptToBase64(value), 100, false);
        }
    }
} </code></pre>
<p>Finally, let's use the new storage we created in our Entity to encrypt the password column:</p>
<pre data-line="" class="language-csdiff line-numbers"><code>using ENV.Data;

namespace Northwind.Demo
{
    public class Users : Entity
    {
        [PrimaryKey]
        public readonly TextColumn Username = new TextColumn("TheUsername", "30");
        public readonly TextColumn Password = new TextColumn("ThePassword", "30") { Storage = new Demo.EncryptedTextStorage()};

        public Users() : base("Users", Shared.DataSources.Northwind1)
        {
        }
    }
} </code></pre>
<h3 id="the-test-drive">The test drive</h3>
<p>Here we add a new user to our table using the entity browser in the application:</p>
<p><img src="2018-01-18_15h10_01.png" alt="2018 01 18 15H10 01" /></p>
<p>And here is how the password is saved to the databse:</p>
<p><img src="2018-01-18_15h09_47.png" alt="2018 01 18 15H09 47" /></p>



                    <hr />Help us improve,
                    <a href="https://github.com/FireflyMigration/firefly-doc/blob/master//20-Getting-Familiar-with-Migrated-Code/50-DataAccess/40-Storage-Explained/03-Creating-our-own-Encrypted-Storage/index.md" target="_blank">Edit this page on GitHub</a>
                    <br /> or email us at
                    <a href="mailto:info@fireflymigration.com?Subject=Firefly%20Documentation%20Website" target="_top">info@fireflymigration.com</a>
                </div>

                <!-- .content -->




            </div>
            <!-- .container-->

            <aside class="left-sidebar">
                <div class="wy-side-nav-search-ff">
                    <a href="" class="test">
                        
                    </a>
                </div>
                <div id="menuTree" </div>
            </aside>
            <!-- .left-sidebar -->

            <aside class="right-sidebar"></aside>
            <!-- .right-sidebar -->

            </div>
            <!-- .middle-->



        </div>


        <script src="assets/js/mermaid.js"></script>
        <script src="assets/js/prism-start.js"></script>
        <script src="assets/js/prism-clike.js"></script>
        <script src="assets/js/prism-markup.js"></script>
        <script src="assets/js/prism-css.js"></script>
        <script src="assets/js/prism-javascript.js"></script>

        <script src="assets/js/prism-diff.js"></script>
        <script src="assets/js/prism-csdiff.js"></script>
        <script src="assets/js/prism-function.js"></script>

        <script src="assets/js/jquery-3.1.1.js"></script>


        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-4806432-3', 'auto');
            ga('send', 'pageview');

        </script>
        <script src="assets/js/tree.js"></script>
        <script language="javascript">
            buildTree('menuTree', 'creating-our-own-encrypted-storage.html', 'previousButton', 'nextButton');
        </script>
</body>

</html>