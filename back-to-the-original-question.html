<!DOCTYPE html>
<html lang="en" class="js flexbox flexboxlegacy canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta charset="utf-8" />
    <meta name="keywords" content="">

    <title>Back to the original question</title>
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />
    <link rel="stylesheet" href="assets/css/toc.css" />
    <link rel="stylesheet" href="assets/css/highlight.css" />
    <link rel="stylesheet" href="assets/css/prism.css" />
    <link rel="stylesheet" href="assets/css/prism-csdiff.css" />


    <link rel="stylesheet" href="assets/css/theme_firefly.css" />
    <link rel="stylesheet" href="assets/css/mermaid.css" />
</head>
<body class="markdown-body" role="document">

    <div class="wrapper">

        <div class="middle">

            <div class="container">

                <div class="content" role="navigation" aria-label="footer navigation">
                    <a id="previousButton" class="btn btn-neutral float-left" style="visibility:hidden">Previous</a> <a id="nextButton" class="btn btn-neutral float-right" style="visibility:hidden">Next</a>
                </div>
                <div class="content"><h1 id="back-to-the-original-question">Back to the original question</h1>
<p>To translate the original question into Northwind terms, let’s say that I would like to count all the Orders of customers who don’t live in “London”.<br />
Here is the original SQL:</p>
<pre><code>select count(*) from Orders where CustomerID not in 
(select CustomerID from Customers where ShipCity='London')
</code></pre>
<p>Let’s start dirty, and then improve step by step:</p>
<pre data-line="" class="language-csdiff line-numbers"><code>var o = new Orders();
var where = new FilterCollection();
where.Add(
"CustomerID not in 
    (select CustomerID from Customers where City='London')");
return o.CountRows(where);
 </code></pre>
<p>Step 1 - let’s replace the usage of the CustomerID column to a token, so if we ever change it in the Entity, this query will keep working:</p>
<pre data-line="" class="language-csdiff line-numbers"><code>var o = new Orders();
var where = new FilterCollection();
where.Add(
  "{0} not in  
      (select CustomerID from Customers where ShipCity='London')"
      ,o.CustomerID);
return o.CountRows(where);
 </code></pre>
<p>Step 2 – let’s take out the value “London” so that we can receive it as a parameter, and keep it SQL injection free:</p>
<pre data-line="" class="language-csdiff line-numbers"><code>var o = new Orders();
var where = new FilterCollection();
where.Add("{0} not in 
  (select CustomerID from Customers where ShipCity={1})"
         ,o.CustomerID,"London");
return o.CountRows(where);
 </code></pre>
<p>Step 3 – let’s use the ‘Customers’ entity name and its column names, instead of writing them in the SQL file itself. This is a bit more tricky. Due to many reasons the method of placing the column as a token, only works on the main entity, which is Orders in our case, so to do that we’ll just insert these values to the SQL string itself. Ironically, this is actually more readable.</p>
<pre data-line="" class="language-csdiff line-numbers"><code>var o = new Orders();
var c = new Customers();
var where = new FilterCollection();
where.Add("{0} not in 
   (select "+c.CustomerID.Name+
  " from "+c.EntityName+
  " where "+c.City.Name+"={1})",o.CustomerID,"London");
return o.CountRows(where);
 </code></pre>
<p>Step 4 – let’s refactor it so that we can have an ‘IsNotInSelect” method. First, let’s see the usage:</p>
<pre data-line="" class="language-csdiff line-numbers"><code>var o = new Orders();
var c = new Customers();
return o.CountRows(IsNotInSelect(o.CustomerID,c.CustomerID,c.City,”London”));
 </code></pre>
<p>Now let’s see the implementation:</p>
<pre data-line="" class="language-csdiff line-numbers"><code>static FilterBase IsNotInSelect
  (ColumnBase col, ColumnBase colInOtherTable,
     TextColumn filterColumn,Text filterValue)
{
    var where = new FilterCollection();
    where.Add("{0} not in 
      (select " + colInOtherTable.Name +
      " from " + colInOtherTable.Entity.EntityName +
      " where " + filterColumn.Name + "={1})", col, filterValue);
    return where;
}
 </code></pre>
<p>Note that we didn’t send the “Customers” entity as a parameter, we simply used the column’s Entity property to figure out the entity that is being used.</p>
<p>This implementation may seem a bit complex, but the beauty of it is that you only do it once – and now you can reuse it all over your code.</p>
<p>Step 5 – Let’s generalize this function further to take care of more complex scenarios with more complex values then “City=’London’”. So I would prefer to send it a filter and use that.</p>
<p>First the usage:</p>
<pre data-line="" class="language-csdiff line-numbers"><code>var o = new Orders();
var c = new Customers();
return o.CountRows(IsNotInSelect
(o.CustomerID,c.CustomerID,c.City.IsEqualTo(“London”)));
 </code></pre>
<p>Note that I’m using the IsEqualTo filter, but I can also use any other filter, like the IsIn that we have defined earlier in this post:</p>
<pre data-line="" class="language-csdiff line-numbers"><code>var o = new Orders();
var c = new Customers();
return o.CountRows(IsNotInSelect
(o.CustomerID,c.CustomerID,c.City.IsIn("London","Madrid")));
 </code></pre>
<br /><hr />Help us improve, <a href="https://github.com/FireflyMigration/firefly-doc/blob/master//02-Development/03-Articles/DataAccess/27-Making-the-most-out-of-Where/07-Back-to-the-original-question.md">Edit this page on GitHub</a></div><!-- .content -->
                
            </div><!-- .container-->
        
            <aside class="left-sidebar">
                <div class="wy-side-nav-search-ff">
                    <a href="" class="test">  <img src="assets/img/logo-big.png"></a>
                </div><div id="menuTree"</div>
            </aside><!-- .left-sidebar -->

            <aside class="right-sidebar"></aside><!-- .right-sidebar -->

        </div><!-- .middle-->



    </div>


    <script src="assets/js/mermaid.js"></script>
    <script src="assets/js/prism-start.js"></script>
    <script src="assets/js/prism-clike.js"></script>
    <script src="assets/js/prism-markup.js"></script>
    <script src="assets/js/prism-css.js"></script>
    <script src="assets/js/prism-javascript.js"></script>

    <script src="assets/js/prism-diff.js"></script>
    <script src="assets/js/prism-csdiff.js"></script>
    <script src="assets/js/prism-function.js"></script>

    <script src="assets/js/jquery-3.1.1.js"></script>
    <script src="assets/js/tree.js"></script>
    <script language="javascript">
        buildTree('menuTree', 'back-to-the-original-question.html', 'previousButton', 'nextButton');
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-4806432-3', 'auto');
  ga('send', 'pageview');

    </script>
</body>
</html>