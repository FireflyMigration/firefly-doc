<!DOCTYPE html>
<html lang="en" class="js flexbox flexboxlegacy canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta charset="utf-8" />
    <meta name="keywords" content="">

    <title>Types, I want more out of it !</title>
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />
    <link rel="stylesheet" href="assets/css/toc.css" />
    <link rel="stylesheet" href="assets/css/highlight.css" />
    <link rel="stylesheet" href="assets/css/prism.css" />
    <link rel="stylesheet" href="assets/css/prism-csdiff.css" />


    <link rel="stylesheet" href="assets/css/theme_firefly.css" />
    <link rel="stylesheet" href="assets/css/mermaid.css" />
</head>

<body class="markdown-body" role="document">
    <div class="wrapper">

        <div class="middle">

            <div class="container">

                <div class="content" role="navigation" aria-label="footer navigation">
                    <a id="previousButton" class="btn btn-neutral float-left" style="visibility:hidden">Previous</a>
                    <a id="nextButton" class="btn btn-neutral float-right" style="visibility:hidden">Next</a>
                </div>
                <div class="content"><h1 id="types-i-want-more-out-of-it">Types, I want more out of it !</h1>
<p>The original usage of types in the migrated application was no more than just having one place in the code, to set up the format and may be a DB name and caption of a column.</p>
<p>Some of the developers use it to set up an Expand handler for all the columns using this type.</p>
<p>So the code looks like :</p>
<pre data-line="" class="language-csdiff line-numbers"><code>using Firefly.Box;
using ENV.Data;
namespace Northwind.Types
{
    /// &lt;summary&gt;Prod ID(T#3)&lt;/summary&gt;
    public class ProdID : NumberColumn
    {
        public ProdID() : base("ProductID","2","Prod ID")
        {
            Expand += () =&gt; new Products.ShowProducts().Run(this);
        }
    }
} </code></pre>
<p><img src="expand_handler.png" alt="" /></p>
<p>So the question is how to get more out of it ?</p>
<p>Since the type is a class we can add more code to it. The first thing we can do is add a method that will return relevant information like the product name.<br />
Using this method here will save the developer the need to use a Relation in the programs.
So now the code will look like that :</p>
<pre data-line="" class="language-csdiff line-numbers"><code>using Firefly.Box;
using ENV.Data;
namespace Northwind.Types
{
    /// &lt;summary&gt;Prod ID(T#3)&lt;/summary&gt;
    public class ProdID : NumberColumn
    {
        public ProdID() : base("ProductID","2","Prod ID")
        {
            Expand += () =&gt; new Products.ShowProducts().Run(this);
        }
 
        Models.Products products;
        public Text GetProductName ()
        {
            if (products == null)
                products = new Models.Products();
            return products.GetValue(products.ProductName, products.ProductID.IsEqualTo(this)); 
        }
    }
} </code></pre>
<p><img src="product_instance.png" alt="" /></p>
<p>Now, whenever this type is used, there is no need to add a Relation to the Products model, you can get the product name directly from the column that use the type, for example:<br />
<img src="Using_type.png" alt="" /><br />
<img src="column_generator_product_id.png" alt="" /></p>
<p>As you can see the column wizard recognizes not only the column itself, but also its public methods, such as the GetProductName, and allows you to use it.</p>
<p>But now what will I do if I need more than just the product name ?<br />
What if I need two or more columns from the Products model ?<br />
The first option looks like more of the same, meaning:</p>
<pre data-line="" class="language-csdiff line-numbers"><code>using Firefly.Box;
using ENV.Data;
namespace Northwind.Types
{
    /// &lt;summary&gt;Prod ID(T#3)&lt;/summary&gt;
    public class ProdID : NumberColumn
    {
 
        public ProdID() : base("ProductID","2","Prod ID")
        {
            Expand += () =&gt; new Products.ShowProducts().Run(this);
        }
 
        Models.Products products;
        public Text GetProductName ()
        {
            if (products == null)
                products = new Models.Products();
            return products.GetValue(products.ProductName, products.ProductID.IsEqualTo(this));
 
        }
        public Number GetProductPrice()
        {
            if (products == null)
                products = new Models.Products();
            return products.GetValue(products.UnitPrice, products.ProductID.IsEqualTo(this));
 
        }
    }
} </code></pre>
<p>The problem is that now we will have two queries going to the database:
<img src="using_profiler.png" alt="" />
So we need to improve our code,  we need one SQL query that will return more than one column a time. To do so we need some ground work. We need to create a new object that will store all the information we need :</p>
<pre data-line="14,15,16,17,18" class="language-csdiff line-numbers"><code>using Firefly.Box;
using ENV.Data;
namespace Northwind.Types
{
    /// &lt;summary&gt;Prod ID(T#3)&lt;/summary&gt;
    public class ProdID : NumberColumn
    {
 
        public ProdID() : base("ProductID","2","Prod ID")
        {
            Expand += () =&gt; new Products.ShowProducts().Run(this);
        }
 
        class ProductInfo
        {
            public Text Name;
            public Number Price;
        }
 
        Models.Products products;
    }
} </code></pre>
<p>Now we need to get the data from the model :</p>
<pre data-line="" class="language-csdiff line-numbers"><code>using Firefly.Box;
using ENV.Data;
namespace Northwind.Types
{
    /// &lt;summary&gt;Prod ID(T#3)&lt;/summary&gt;
    public class ProdID : NumberColumn
    {
 
        public ProdID() : base("ProductID","2","Prod ID")
        {
            Expand += () =&gt; new Products.ShowProducts().Run(this);
        }
 
        class ProductInfo
        {
            public Text Name;
            public Number Price;
        }
 
        Models.Products products;
 
        ProductInfo GetInfo()
        {
            if (products == null)
                products = new Models.Products();
            var result = products.GetValue(() =&gt; new ProductInfo
            {
                Name = products.ProductName,
                Price = products.UnitPrice
            }, products.ProductID.IsEqualTo(this));
            if (result != null)
                return result;
            return new ProductInfo { Name = "", Price = 0};
        }
    }
} </code></pre>
<p><img src="data_from_model_explain.png" alt="" />
Let us get the two methods returning the name and the price back, but this time we will use the ProductInfo object</p>
<pre data-line="" class="language-csdiff line-numbers"><code>using Firefly.Box;
using ENV.Data;
namespace Northwind.Types
{
    /// &lt;summary&gt;Prod ID(T#3)&lt;/summary&gt;
    public class ProdID : NumberColumn
    {
 
        public ProdID() : base("ProductID","2","Prod ID")
        {
            Expand += () =&gt; new Products.ShowProducts().Run(this);
        }
 
        class ProductInfo
        {
            public Text Name;
            public Number Price;
        }
 
        Models.Products products;
 
        ProductInfo GetInfo()
        {
            if (products == null)
                products = new Models.Products();
            var result = products.GetValue(() =&gt; new ProductInfo
            {
                Name = products.ProductName,
                Price = products.UnitPrice
            }, products.ProductID.IsEqualTo(this));
            if (result != null)
                return result;
            return new ProductInfo { Name = "", Price = 0};
        }
        public Text GetProductName()
        {
            return GetInfo().Name;
 
        }
        public Number GetProductPrice()
        {
            return GetInfo().Price;
        }
    }
} </code></pre>
<p>This time we can see that there is only one database call:
<img src="using_profiler_1.png" alt="" /></p>
<p>If you have an older version of firefly ENV (Before version 21719), your version does not support the lambda option in GetValue method. To add it to your version add and replace the current GetValue code in your ENV.Data.Entity class with the following code :</p>
<pre data-line="" class="language-csdiff line-numbers"><code>Dictionary&lt;object, Dictionary&lt;string, object&gt;&gt; _getCache =
            new Dictionary&lt;object, Dictionary&lt;string, object&gt;&gt;();
        public T GetValue&lt;T&gt;(TypedColumnBase&lt;T&gt; column, FilterBase where, Sort s = null)
        {
            string cacheKey = null;
            Dictionary&lt;string, object&gt; specificCache = null;
            cacheKey = FilterHelper.ToSQLWhere(where, false, this);
 
            if (!_getCache.TryGetValue(column, out specificCache))
            {
                specificCache = new Dictionary&lt;string, object&gt;();
                _getCache.Add(column, specificCache);
            }
            else
            {
                object cachedResult;
                if (specificCache.TryGetValue(cacheKey, out cachedResult))
                    return (T)cachedResult;
            }
 
 
            var i = new Iterator(this, column);
            T result;
            if (s != null)
            {
                bool valueFound;
 
                result = i.GetValue(column, where, s, out valueFound);
            }
            else
            {
                result = i.GetValue(column, where);
            }
            if (specificCache != null)
                specificCache.Add(cacheKey, result);
            return result;
        }
        public T GetValue&lt;T&gt;(Func&lt;T&gt; expression, FilterBase where, params ColumnBase[] selectColumns)
        {
            return GetValue(expression, where, null, selectColumns);
        }
        public T GetValue&lt;T&gt;(Func&lt;T&gt; expression, FilterBase where, Sort s = null, params ColumnBase[] selectColumns)
        {
            string cacheKey = null;
            Dictionary&lt;string, object&gt; specificCache = null;
            object id = expression;
            cacheKey = FilterHelper.ToSQLWhere(where, false, this);
 
            if (!_getCache.TryGetValue(id, out specificCache))
            {
                specificCache = new Dictionary&lt;string, object&gt;();
                _getCache.Add(id, specificCache);
            }
            else
            {
                object cachedResult;
                if (specificCache.TryGetValue(cacheKey, out cachedResult))
                    return (T)cachedResult;
            }
 
 
            var bp = new BusinessProcess { };
            if (s == null)
                bp.Relations.Add(this, where);
            else
                bp.Relations.Add(this, where, s);
            if (selectColumns != null &amp;&amp; selectColumns.Length &gt; 0)
                bp.Columns.Add(selectColumns);
 
            T result = default(T);
            bp.ForFirstRow(() =&gt; result = expression());
 
            if (specificCache != null)
                specificCache.Add(cacheKey, result);
            return result;
        } </code></pre>


                <br />
                        <a id="previousButton" class="btn btn-neutral float-left" style="visibility:hidden">Previous</a>

                        <a id="nextButton" class="btn btn-neutral" style="visibility:hidden;float:right">Next</a>
                    <hr />Help us improve,
                    <a href="https://github.com/FireflyMigration/firefly-doc/blob/master//30-Maintaining-the-Migrated-Application/40-Refactoring-Migrated-Code/10-Types-I-want-more-out-of-it/index.md" target="_blank">Edit this page on GitHub</a>
                    <br /> or email us at
                    <a href="mailto:info@fireflymigration.com?Subject=Firefly%20Documentation%20Website" target="_top">info@fireflymigration.com</a>
                </div>

                <!-- .content -->




            </div>
            <!-- .container-->

            <aside class="left-sidebar">
                <div class="wy-side-nav-search-ff">
                    <a href="" class="test">
                        <img src="assets/img/logo-big.png">
                    </a>
                </div>
                <div id="menuTree" </div>
            </aside>
            <!-- .left-sidebar -->

            <aside class="right-sidebar"></aside>
            <!-- .right-sidebar -->

            </div>
            <!-- .middle-->



        </div>


        <script src="assets/js/mermaid.js"></script>
        <script src="assets/js/prism-start.js"></script>
        <script src="assets/js/prism-clike.js"></script>
        <script src="assets/js/prism-markup.js"></script>
        <script src="assets/js/prism-css.js"></script>
        <script src="assets/js/prism-javascript.js"></script>

        <script src="assets/js/prism-diff.js"></script>
        <script src="assets/js/prism-csdiff.js"></script>
        <script src="assets/js/prism-function.js"></script>

        <script src="assets/js/jquery-3.1.1.js"></script>


        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-4806432-3', 'auto');
            ga('send', 'pageview');

        </script>
        <script src="assets/js/tree.js"></script>
        <script language="javascript">
            buildTree('menuTree', 'types-i-want-more-out-of-it.html', 'previousButton', 'nextButton');
        </script>
</body>

</html>