<!DOCTYPE html>
<html lang="en" class="js flexbox flexboxlegacy canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8" />
    <meta name="keywords" content="">

    <title>Running SQLs with parameters in Management Studio</title>
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />
    <link rel="stylesheet" href="assets/css/toc.css" />
    <link rel="stylesheet" href="assets/css/highlight.css" />
    <link rel="stylesheet" href="assets/css/prism.css" />
    <link rel="stylesheet" href="assets/css/prism-csdiff.css" />


    <link rel="stylesheet" href="assets/css/theme_firefly.css" />
    <link rel="stylesheet" href="assets/css/mermaid.css" />
</head>

<body class="markdown-body" role="document">
    <div class="wrapper" id="root">
        <div class="backdrop"></div>
        <div class="top-bar" role="navigation" aria-label="footer navigation">
            <div style="display:flex;">
                <div>
                    <a id="menu" class="btn btn-neutral">&#9776; </a>
                </div>
                <img src="assets/img/logo-big.png">
            </div>
            <div>
                <a id="previousButton" class="btn btn-neutral" style="visibility:hidden">Previous</a>
                <a id="nextButton" class="btn btn-neutral" style="visibility:hidden">Next</a>
            </div>
        </div>
        <div class="middle">

            <div class="container">

                <div class="content"><h1 id="running-sqls-with-parameters-in-management-studio">Running SQLs with parameters in Management Studio</h1>
<p>Any SQL that is written to the profiler, dblog or query exceptions, now includes the bound parameters as a set of <code>declare</code> statements that SQL Management studio can use to run that sql with it's bound parameters.</p>
<p><img src="2019-07-14_10h32_17.png" alt="Profiler screenshot" /></p>
<p>See</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/9xkmeGIZZx4" frameborder="0" allowfullscreen></iframe>
<h2 id="integrating-to-older-versions-of-env">Integrating to older versions of ENV</h2>
<p>The change was done between versions: 31718 and 31719 - you can run a migration of both these versions and compare env.
The files that were touched are:</p>
<ol>
<li>LogDatabaseWrapper.cs</li>
<li>SQLClient.cs</li>
<li>Profiler.cs</li>
</ol>
<h2 id="the-code-for-it">The code for it</h2>
<p>Here's the relevant code that you need for older versions of ENV - it's not identical to what we have in a current migration, but it's suited for you to integrate easily</p>
<p>In the class <code>LogDatabaseWrapper</code> replace the <code>ParameterInfo</code> method with the following code:</p>
<pre data-line="" class="language-csdiff line-numbers"><code>internal static string ParameterInfo(string title, IEnumerable parameters)
{
    var sw = new StringWriter();
    bool first = true;
    foreach (IDbDataParameter parameter in parameters)
    {
        if (first)
        {
            first = false;
            sw.WriteLine("\n{0}:", title);
        }
        var x = parameter.Value;
        if (x is DBNull)
            x = "null";
        if (x is int &amp;&amp; (parameter.ParameterName == "@ccopt" || parameter.ParameterName == "@scrollopt"))
        {
            x = x.ToString() + " /*" + ((int)x).ToString("X") + "*/";
        }
        else if (x is string|| x is TimeSpan)
        {
            x = "'" + x.ToString().Replace("'", "''") + "'";
        }
        else if (x is DateTime)
        {
            x = "'" + ((DateTime)x).ToString("yyyy-MM-dd HH:mm:ss") + "'";
        }
        if (x!=null)
            sw.WriteLine(string.Format("declare {0} {2} = {1}", parameter.ParameterName, x, SQLClientEntityDataProvider.TranslateParameterTypeToSQLType(parameter)));
    }
    return sw.ToString();
}
internal static string TranslateParameterTypeToSQLType(IDbDataParameter p)
{
    switch (p.DbType)
    {
        case DbType.Int16:
            return "int";
        case DbType.Int32:
            return "int";
        case DbType.Int64:
            return "bigint";
        case DbType.Decimal:
            return string.Format("decimal ({0},{1})", p.Precision, p.Scale);
        case DbType.DateTime:
            return "datetime";
        case DbType.AnsiString:
            return "varchar(" + (p.Size == -1 ? "max" : p.Size.ToString()) + ")";
        case DbType.String:
            return "nvarchar(" + (p.Size == -1 ? "max" : p.Size.ToString()) + ")";
        case DbType.Binary:
            return "varbinary(" + (((byte[])p.Value).Length &gt; 8000 ? ((byte[])p.Value).Length.ToString() : "8000") + ")";
        default:
            return "varchar(max)";
    }
} </code></pre>
<p>In the file <code>SQLClient.cs</code> in the class <code>SQLDataProviderHelper</code> fix the <code>ProcessException</code> method as follows:</p>
<pre data-line="13" class="language-csdiff line-numbers"><code>internal Exception ProcessException(Exception e, Firefly.Box.Data.Entity entity, IDbCommand command)
{
    if (command != null)
    {
        if (!e.Data.Contains("SQL"))
            using (var s = new StringWriter())
            {
                s.WriteLine(command.CommandText);
-               foreach (IDbDataParameter p in command.Parameters)
-               {
-                   s.WriteLine(string.Format("{0}({2}) = {1}", p.ParameterName, p.Value, p.DbType));
-               }
                s.WriteLine (LogDatabaseWrapper.TextLogWriter.ParameterInfo("Parameter Info", command.Parameters));
                
                e.Data.Add("SQL", s.ToString());
            }
        command.Dispose();
    }
    .... </code></pre>



                    <hr />Help us improve,
                    <a href="https://github.com/FireflyMigration/firefly-doc/blob/master//30-Maintaining-the-Migrated-Application/20-Debugging-the-Migrated-Application/Running-SQLs-with-parameters-in-Management-Studio.md" target="_blank">Edit this page on GitHub</a>
                    <br /> or email us at
                    <a href="mailto:info@fireflymigration.com?Subject=Firefly%20Documentation%20Website" target="_top">info@fireflymigration.com</a>
                </div>

                <!-- .content -->




            </div>
            <!-- .container-->

            <aside class="left-sidebar">
                <div class="wy-side-nav-search-ff">
                    <a href="" class="test">
                        
                    </a>
                </div>
                <div id="menuTree" </div>
            </aside>
            <!-- .left-sidebar -->

            <aside class="right-sidebar"></aside>
            <!-- .right-sidebar -->

            </div>
            <!-- .middle-->



        </div>


        <script src="assets/js/mermaid.js"></script>
        <script src="assets/js/prism-start.js"></script>
        <script src="assets/js/prism-clike.js"></script>
        <script src="assets/js/prism-markup.js"></script>
        <script src="assets/js/prism-css.js"></script>
        <script src="assets/js/prism-javascript.js"></script>

        <script src="assets/js/prism-diff.js"></script>
        <script src="assets/js/prism-csdiff.js"></script>
        <script src="assets/js/prism-function.js"></script>

        <script src="assets/js/jquery-3.1.1.js"></script>


        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-4806432-3', 'auto');
            ga('send', 'pageview');

        </script>
        <script src="assets/js/tree.js"></script>
        <script language="javascript">
            buildTree('menuTree', 'running-sqls-with-parameters-in-management-studio.html', 'previousButton', 'nextButton');
        </script>
</body>

</html>